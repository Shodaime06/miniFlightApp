<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MiniFlight - App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<nav class="navbar bg-white border-bottom">
  <div class="container">
    <div class="d-flex align-items-center gap-2">
      <span class="fw-semibold">MiniFlight</span>
      <span id="badgeRole" class="badge text-bg-secondary">...</span>
    </div>
    <div class="d-flex gap-2">
      <span id="who" class="text-muted small"></span>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">Çıkış</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div id="userPanel" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Uçuşlar</h4>
      <input id="flightSearch" class="form-control" style="max-width:300px;" placeholder="Ankara, İstanbul, Berlin...">
    </div>
    <div id="flightsGrid" class="row g-3"></div>

    <div class="card mt-4 shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-3">Rezervasyonlarım</h5>
        <div id="myBookings" class="small text-muted">Yükleniyor...</div>
      </div>
    </div>
  </div>

  <div id="adminPanel" class="d-none">
    <div class="row g-3">
      <div class="col-lg-7">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Admin: Uçuş Yönetimi</h4>
              <button class="btn btn-primary btn-sm" id="btnNewFlight">Yeni Uçuş</button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th>ID</th><th>From</th><th>To</th><th>Time</th><th>Cap</th><th>Avail</th><th>₺</th><th></th>
                </tr>
                </thead>
                <tbody id="adminFlights"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Admin: Üyeler</h4>
              <button class="btn btn-success btn-sm" id="btnNewUser">Yeni Üye</button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr><th>ID</th><th>Email</th><th>Roles</th><th></th></tr>
                </thead>
                <tbody id="adminUsers"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="flightModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="flightModalTitle">Uçuş</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="flightId">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">From</label>
            <input id="fromCity" class="form-control" placeholder="Ankara">
          </div>
          <div class="col-6">
            <label class="form-label">To</label>
            <input id="toCity" class="form-control" placeholder="İstanbul">
          </div>
          <div class="col-12">
            <label class="form-label">Departure (ISO)</label>
            <input id="departureTime" class="form-control" placeholder="2026-02-02T10:00">
          </div>
          <div class="col-4">
            <label class="form-label">Capacity</label>
            <input id="capacity" class="form-control" type="number" value="100">
          </div>
          <div class="col-4">
            <label class="form-label">Available</label>
            <input id="seatsAvailable" class="form-control" type="number" value="100">
          </div>
          <div class="col-4">
            <label class="form-label">Price</label>
            <input id="price" class="form-control" type="number" value="900">
          </div>
        </div>
        <div id="flightModalMsg" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button class="btn btn-primary" id="btnSaveFlight">Kaydet</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Yeni Üye</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Email</label>
          <input id="newUserEmail" class="form-control" placeholder="new@mail.com">
        </div>
        <div class="mb-2">
          <label class="form-label">Password</label>
          <input id="newUserPassword" class="form-control" type="password" placeholder="min 6">
        </div>
        <div class="mb-2">
          <label class="form-label">Role</label>
          <select id="newUserRole" class="form-select">
            <option value="USER">USER</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>
        <div id="userModalMsg" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button class="btn btn-success" id="btnCreateUser">Oluştur</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/auth.js"></script>
<script>
  const flightModal = new bootstrap.Modal(document.getElementById('flightModal'));
  const userModal = new bootstrap.Modal(document.getElementById('userModal'));

  function fmtTime(t) { return (t || "").replace("T", " "); }

  async function init() {
    try {
      const me = await Auth.api("/api/me");
      document.getElementById("who").textContent = me.email + " (#" + me.id + ")";
      const roles = Array.from(me.roles || []);
      const isAdmin = roles.includes("ADMIN");
      document.getElementById("badgeRole").className = "badge " + (isAdmin ? "text-bg-danger" : "text-bg-primary");
      document.getElementById("badgeRole").textContent = isAdmin ? "ADMIN" : "USER";

      if (isAdmin) {
        document.getElementById("adminPanel").classList.remove("d-none");
        await loadAdminFlights();
        await loadAdminUsers();
        wireAdmin();
      } else {
        document.getElementById("userPanel").classList.remove("d-none");
        await loadUserFlights();
        await loadMyBookings();
        wireUserSearch();
      }
    } catch (e) {
      window.location.href = "/login.html";
    }
  }

  let cachedFlights = [];

  function wireUserSearch() {
    const inp = document.getElementById("flightSearch");
    inp.addEventListener("input", () => renderUserFlights(inp.value.trim().toLowerCase()));
  }

  async function loadUserFlights() {
    cachedFlights = await Auth.api("/api/user/flights");
    renderUserFlights("");
  }

  function renderUserFlights(q) {
    const grid = document.getElementById("flightsGrid");
    grid.innerHTML = "";

    const list = cachedFlights.filter(f => {
      const text = (f.fromCity + " " + f.toCity + " " + (f.departureTime||"")).toLowerCase();
      return !q || text.includes(q);
    });

    for (const f of list) {
      const percent = f.capacity ? Math.round((f.seatsAvailable / f.capacity) * 100) : 0;
      const col = document.createElement("div");
      col.className = "col-md-6 col-lg-4";
      col.innerHTML = `
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <div class="fw-semibold">${f.fromCity} → ${f.toCity}</div>
                <div class="text-muted small">${fmtTime(f.departureTime)}</div>
              </div>
              <div class="text-end">
                <div class="fw-semibold">₺${f.price}</div>
                <div class="text-muted small">ID: ${f.id}</div>
              </div>
            </div>
            <hr/>
            <div class="small text-muted mb-2">Koltuk: ${f.seatsAvailable} / ${f.capacity} (${percent}%)</div>
            <div class="input-group input-group-sm">
              <input class="form-control" type="number" min="1" value="1" id="seat_${f.id}">
              <button class="btn btn-success" onclick="book(${f.id})">Ayırt</button>
            </div>
            <div class="small mt-2" id="msg_${f.id}"></div>
          </div>
        </div>
      `;
      grid.appendChild(col);
    }
  }

  async function book(flightId) {
    const seatEl = document.getElementById("seat_" + flightId);
    const seatCount = parseInt(seatEl.value || "1", 10);
    const msg = document.getElementById("msg_" + flightId);
    msg.className = "small mt-2";
    msg.textContent = "";

    try {
      const b = await Auth.api("/api/user/bookings", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ flightId, seatCount })
      });
      msg.classList.add("text-success");
      msg.textContent = `OK ✅ ${b.seatCount} koltuk. Toplam ₺${b.totalPrice}`;
      await loadUserFlights();
      await loadMyBookings();
    } catch (e) {
      msg.classList.add("text-danger");
      msg.textContent = e.message || "Rezervasyon olmadı";
    }
  }

  async function loadMyBookings() {
    const list = await Auth.api("/api/user/bookings");
    const el = document.getElementById("myBookings");
    if (!list.length) { el.textContent = "Henüz rezervasyon yok."; return; }
    el.innerHTML = list.map(b => `#${b.id} | flightId=${b.flightId} | seats=${b.seatCount} | total=₺${b.totalPrice}`).join("<br/>");
  }

  function wireAdmin() {
    document.getElementById("btnNewFlight").addEventListener("click", () => openFlightModal(null));
    document.getElementById("btnSaveFlight").addEventListener("click", saveFlight);

    document.getElementById("btnNewUser").addEventListener("click", () => {
      document.getElementById("userModalMsg").textContent = "";
      document.getElementById("newUserEmail").value = "";
      document.getElementById("newUserPassword").value = "";
      document.getElementById("newUserRole").value = "USER";
      userModal.show();
    });
    document.getElementById("btnCreateUser").addEventListener("click", createUser);
  }

  async function loadAdminFlights() {
    const list = await Auth.api("/api/admin/flights");
    const tbody = document.getElementById("adminFlights");
    tbody.innerHTML = "";
    for (const f of list) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${f.id}</td>
        <td>${f.fromCity}</td>
        <td>${f.toCity}</td>
        <td class="small">${fmtTime(f.departureTime)}</td>
        <td>${f.capacity}</td>
        <td>${f.seatsAvailable}</td>
        <td>${f.price}</td>
        <td class="text-end">
          <button class="btn btn-outline-primary btn-sm" onclick='openFlightModal(${JSON.stringify(f)})'>Edit</button>
          <button class="btn btn-outline-danger btn-sm" onclick='deleteFlight(${f.id})'>Del</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function openFlightModal(f) {
    document.getElementById("flightModalMsg").textContent = "";
    document.getElementById("flightId").value = f ? f.id : "";
    document.getElementById("fromCity").value = f ? f.fromCity : "";
    document.getElementById("toCity").value = f ? f.toCity : "";
    document.getElementById("departureTime").value = f ? f.departureTime : "";
    document.getElementById("capacity").value = f ? f.capacity : 100;
    document.getElementById("seatsAvailable").value = f ? f.seatsAvailable : 100;
    document.getElementById("price").value = f ? f.price : 900;
    document.getElementById("flightModalTitle").textContent = f ? ("Uçuş Edit #" + f.id) : "Yeni Uçuş";
    flightModal.show();
  }

  async function saveFlight() {
    const id = document.getElementById("flightId").value.trim();
    const dto = {
      fromCity: document.getElementById("fromCity").value.trim(),
      toCity: document.getElementById("toCity").value.trim(),
      departureTime: document.getElementById("departureTime").value.trim(),
      capacity: parseInt(document.getElementById("capacity").value || "0", 10),
      seatsAvailable: parseInt(document.getElementById("seatsAvailable").value || "0", 10),
      price: parseInt(document.getElementById("price").value || "0", 10),
    };

    const msg = document.getElementById("flightModalMsg");
    msg.className = "small mt-2";
    msg.textContent = "";

    try {
      if (!dto.departureTime.includes("T")) throw new Error("departureTime ISO olmalı: 2026-02-02T10:00");
      if (!id) {
        await Auth.api("/api/admin/flights", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(dto)
        });
      } else {
        await Auth.api("/api/admin/flights/" + id, {
          method: "PUT",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(dto)
        });
      }
      msg.classList.add("text-success");
      msg.textContent = "Kaydedildi ✅";
      await loadAdminFlights();
      setTimeout(() => flightModal.hide(), 500);
    } catch (e) {
      msg.classList.add("text-danger");
      msg.textContent = e.message || "Kaydetme hatası";
    }
  }

  async function deleteFlight(id) {
    if (!confirm("Uçuş silinsin mi?")) return;
    await Auth.api("/api/admin/flights/" + id, { method: "DELETE" });
    await loadAdminFlights();
  }

  async function loadAdminUsers() {
    const list = await Auth.api("/api/admin/users");
    const tbody = document.getElementById("adminUsers");
    tbody.innerHTML = "";
    for (const u of list) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.id}</td>
        <td class="small">${u.email}</td>
        <td class="small">${(u.roles||[]).join(",")}</td>
        <td class="text-end">
          <button class="btn btn-outline-danger btn-sm" onclick="deleteUser(${u.id}, '${u.email}')">Del</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function createUser() {
    const dto = {
      email: document.getElementById("newUserEmail").value.trim(),
      password: document.getElementById("newUserPassword").value,
      role: document.getElementById("newUserRole").value
    };
    const msg = document.getElementById("userModalMsg");
    msg.className = "small mt-2";
    msg.textContent = "";

    try {
      await Auth.api("/api/admin/users", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(dto)
      });
      msg.classList.add("text-success");
      msg.textContent = "Oluşturuldu ✅";
      await loadAdminUsers();
      setTimeout(() => userModal.hide(), 500);
    } catch (e) {
      msg.classList.add("text-danger");
      msg.textContent = e.message || "Üye oluşturma hatası";
    }
  }

  async function deleteUser(id, email) {
    if (!confirm(`Silinsin mi? ${email} (#${id})`)) return;
    await Auth.api("/api/admin/users/" + id, { method: "DELETE" });
    await loadAdminUsers();
  }

  document.getElementById("btnLogout").addEventListener("click", async () => {
    await Auth.logout();
    window.location.href = "/login.html";
  });

  init();
</script>
</body>
</html>
